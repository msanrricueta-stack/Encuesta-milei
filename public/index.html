app.post("/votar", (req, res) => {
  const votosPath = path.join(__dirname, "votos.json");
  let data = { votos: {}, ips: [] };

  if (fs.existsSync(votosPath)) {
    data = JSON.parse(fs.readFileSync(votosPath, "utf8"));
  }

  const ip = req.headers['x-forwarded-for'] || req.socket.remoteAddress;

  if (data.ips.includes(ip)) {
    return res.status(403).json({ error: "Ya votaste desde esta IP." });
  }

  const opcion = req.body.opcion;
  data.votos[opcion] = (data.votos[opcion] || 0) + 1;
  data.ips.push(ip);

  fs.writeFileSync(votosPath, JSON.stringify(data, null, 2));
  res.json({ ok: true, votos: data.votos });
});
